<!DOCTYPE html>
<html>
<head>
    <title>1x1 Matchmaking System</title>
    <script>
        var ws;
        var matchId;

        var userData;

        async function getUserData() {
            const token = localStorage.getItem("auth_token");
            const response = await fetch('/profile/', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                userData = await response.json();
                // Теперь userData содержит данные пользователя
                // Запускаем WebSocket, используя ID пользователя
                startWebSocket(userData.id);
            } else {
                console.error('Failed to fetch user data.');
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            getUserData();
        });

        function startWebSocket(userId) {
            ws = new WebSocket(`ws://localhost:8000/finding-match/1x1/ws?userid=${userId}`);
            userId = userData.id
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                switch (data.action) {
                    case 'matchFound':
                        matchId = Number(data.matchId);
                        document.getElementById('matchmakingStatus').textContent = `Match with ID ${data.matchId} found. Please confirm your readiness.`;
                        document.getElementById('confirmReady').style.display = 'block';
                        document.getElementById('notConfirm').style.display = 'block';
                        break;
                    case 'matchCancelled':
                        document.getElementById('matchmakingStatus').textContent = 'Match cancelled. Waiting for a new match...';
                        hideConfirmationButtons();
                        break;
                    case 'matchResearch':
                        document.getElementById('matchmakingStatus').textContent = 'Searching for a new match...';
                        break;
                    case 'matchStarted':
                        document.getElementById('matchmakingStatus').textContent = 'Match is starting...';
                        break;
                    default:
                        console.log('Unknown action:', data.action);
                }
            };

            ws.onerror = function(event) {
                console.error('WebSocket error:', event);
            };
        }

        async function startMatchmaking() {
            userId = userData.id
            if (userId) {
                const response = await fetch(`http://localhost:8000/finding-match/1x1/start_search/${userId}`, {
                    method: 'POST'
                });
                if (response.ok) {
                    document.getElementById('matchmakingStatus').textContent = 'Searching for a match...';
                }
            } else {
                alert('User ID is required to start matchmaking.');
            }
        }

    function hideConfirmationButtons() {
        document.getElementById('confirmReady').style.display = 'none';
        document.getElementById('notConfirm').style.display = 'none';
    }

    function confirmReady() {
        console.log(matchId);
        userId = userData.id
        if (matchId && userId) {
            fetch(`http://localhost:8000/finding-match/1x1/confirm_ready/${matchId}/${userId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    if (data.status === 'confirmed') {
                        document.getElementById('matchmakingStatus').textContent = 'You confirmed the match.';
                    }
                });
        }
        hideConfirmationButtons();
    }

    function notConfirmReady() {
        userId = userData.id
        if (matchId && userId) {
            fetch(`/finding-match/1x1/not_ready/${matchId}/${userId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    if (data.status === 'search restarted for opposing user') {
                        document.getElementById('matchmakingStatus').textContent = 'Match declined.';
                    }
                });
        }
        hideConfirmationButtons()
    }

    </script>
</head>
<body>
    <h1>1x1 Matchmaking</h1>

    <h2>User Data:</h2>
    <pre id="userData"></pre>

    <button onclick="startMatchmaking()">Start Matchmaking</button>
    <div id="matchmakingStatus">Waiting to start matchmaking...</div>
    <button id="confirmReady" style="display:none;" onclick="confirmReady()">Confirm Ready</button>
    <button id="notConfirm" style="display:none;" onclick="notConfirmReady()">Not Confirm</button>

</body>
</html>
